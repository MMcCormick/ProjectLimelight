<script>
  $(function() {
    var topic_image_uploader = new plupload.Uploader({
      runtimes : "flash,browserplus,gears,silverlight,html5",
      browse_button : 'topic_uploadB',
      max_file_size : '2mb',
      url : "<%= upload_tmp_path %>",
      container: 'topic_uploadB',
      flash_swf_url: "/assets/javascripts/plupload/plupload.flash.swf",
      silverlight_xap_url: "/assets/javascripts/plupload/plupload.silverlight.xap",
      multipart: true,
      multipart_params: {
        "authenticity_token" : '<%= form_authenticity_token %>'
      }
    });

    topic_image_uploader.bind('FilesAdded', function(up, files) {
    });

    topic_image_uploader.bind('QueueChanged', function() {
      console.log('File Added');
      topic_image_uploader.start();
    })

    topic_image_uploader.bind('UploadProgress', function(up, file) {
      if (file.percent == 100)
      {
        $('#topic_uploadB-progress').html('100% uploaded... Finalizing...')
      }
      else {
        $('#topic_uploadB-progress').html(file.percent + "% uploaded...");
      }
    });

    topic_image_uploader.bind("FileUploaded", function(up, file, data) {
      params = $.parseJSON(data.response);
      $.ajax({
        url: '<%= topic_picture_update_path %>',
        dataType: 'json',
        type: 'put',
        data: {image_location: params.image_path},
        success: function(response) {
          $('.topic-image').each(function(i,val) {
            var img_src = $(val).attr('src');
            var timestamp = new Date().getTime();
            $(val).attr('src',img_src+'&'+timestamp);
          });
          $('#topic_uploadB-progress').oneTime(2000, 'finalizing', function() {
            $(this).html('');
          })
        }
      })
    })

    topic_image_uploader.init();
  });
</script>